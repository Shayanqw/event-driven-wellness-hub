services:
  api-gateway:
    build:
      context: ./api-gateway
    ports:
    - 8092:8080
    environment:
    - SPRING_CLOUD_GATEWAY_ROUTES_WELLNESS_URI=http://wellness-resource-service:8083
    - SPRING_CLOUD_GATEWAY_ROUTES_GOALS_URI=http://goal-tracking-service:8083
    - SPRING_CLOUD_GATEWAY_ROUTES_EVENTS_URI=http://event-service:8083
    - KEYCLOAK_JWK_SET_URI=http://keycloak:8080/realms/wellness-hub/protocol/openid-connect/certs
    - REDIS_HOST=redis
    - REDIS_PORT=6379
    depends_on:
    - wellness-resource-service
    - goal-tracking-service
    - event-service
    - keycloak
    - redis
    restart: always
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: keycloak
    environment:
    - KEYCLOAK_ADMIN=admin
    - KEYCLOAK_ADMIN_PASSWORD=admin
    - KC_DB=postgres
    - KC_DB_URL=jdbc:postgresql://postgres-keycloak:5432/keycloak
    - KC_DB_USERNAME=keycloak
    - KC_DB_PASSWORD=keycloak
    - KC_HOSTNAME_STRICT=false
    - KC_HTTP_ENABLED=true
    ports:
    - 8090:8080
    command: start-dev --import-realm
    volumes:
    - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
    depends_on:
    - postgres-keycloak
    restart: always
  postgres-keycloak:
    image: postgres:15-alpine
    container_name: postgres-keycloak
    environment:
    - POSTGRES_DB=keycloak
    - POSTGRES_USER=keycloak
    - POSTGRES_PASSWORD=keycloak
    volumes:
    - keycloak_data:/var/lib/postgresql/data
    restart: always
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
    - 2181:2181
    restart: always
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
    - zookeeper
    ports:
    - 9092:9092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    restart: always
  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.0
    container_name: schema-registry
    depends_on:
    - kafka
    ports:
    - 8085:8081
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: kafka:29092
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
    restart: always
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
    - 9090:9090
    volumes:
    - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    - prometheus_data:/prometheus
    command:
    - --config.file=/etc/prometheus/prometheus.yml
    - --storage.tsdb.path=/prometheus
    restart: always
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
    - 3000:3000
    environment:
    - GF_SECURITY_ADMIN_USER=admin
    - GF_SECURITY_ADMIN_PASSWORD=admin
    - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
    - grafana_data:/var/lib/grafana
    depends_on:
    - prometheus
    - loki
    restart: always
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
    - 3100:3100
    volumes:
    - ./loki/loki-config.yml:/etc/loki/local-config.yaml
    - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    restart: always
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
    - ./promtail/promtail-config.yml:/etc/promtail/config.yml
    - /var/lib/docker/containers:/var/lib/docker/containers:ro
    - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yml
    depends_on:
    - loki
    restart: always
  wellness-resource-service:
    build:
      context: ./wellness-resource-service
    expose:
    - '8083'
    environment:
    - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-wellness:5432/wellnessdb?sslmode=disable
    - SPRING_DATASOURCE_USERNAME=postgres
    - SPRING_DATASOURCE_PASSWORD=password
    - SPRING_DATA_REDIS_HOST=redis
    depends_on:
    - postgres-wellness
    - redis
    restart: always
  goal-tracking-service:
    build:
      context: ./goal-tracking-service
    expose:
    - '8083'
    environment:
    - SPRING_DATA_MONGODB_HOST=mongodb
    - SPRING_DATA_MONGODB_PORT=27017
    - SPRING_DATA_MONGODB_DATABASE=goaldatabase
    - RESOURCE_SERVICE_BASE_URL=http://wellness-resource-service:8083
    - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:29092
    - SCHEMA_REGISTRY_URL=http://schema-registry:8081
    depends_on:
    - mongodb
    - wellness-resource-service
    - kafka
    restart: always
  event-service:
    build:
      context: ./event-service
    expose:
    - '8083'
    environment:
    - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-event:5432/eventdb?sslmode=disable
    - SPRING_DATASOURCE_USERNAME=event_user
    - SPRING_DATASOURCE_PASSWORD=password
    - SPRING_JPA_HIBERNATE_DDL_AUTO=update
    - RESOURCE_SERVICE_BASE_URL=http://wellness-resource-service:8083
    - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:29092
    - SCHEMA_REGISTRY_URL=http://schema-registry:8081
    depends_on:
    - postgres-event
    - wellness-resource-service
    - kafka
    restart: always
  postgres-wellness:
    image: postgres:14-alpine
    container_name: postgres-wellness
    environment:
    - POSTGRES_DB=wellnessdb
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=password
    restart: always
  postgres-event:
    image: postgres:16
    container_name: event-postgres
    environment:
    - POSTGRES_DB=eventdb
    - POSTGRES_USER=event_user
    - POSTGRES_PASSWORD=password
    - SPRING_JPA_HIBERNATE_DDL_AUTO=update
    restart: always
  mongodb:
    image: mongo:6.0
    container_name: goal-mongodb
    ports:
    - 27018:27017
    restart: always
  redis:
    image: redis:alpine
    container_name: aj-redis
    ports:
    - 6379:6379
    restart: always
volumes:
  pgdata: {}
  keycloak_data: {}
  prometheus_data: {}
  grafana_data: {}
  loki_data: {}
